---
import PostList from "@components/stalux/posts/postList.astro";
import TagHeader from "@components/stalux/tags/tagHeader.astro";
import { getCollection, type CollectionEntry } from "astro:content";
import Stalux from "@layouts/Stalux.astro";
import dayjs from "dayjs";
import Navs from "@components/stalux/layout/navs.astro";
const stalux = (await getCollection("config"))[0].data;
export async function getStaticPaths() {
    const posts = await getCollection("posts", ({ data }) => !data.draft);
    const counts = new Map<string, number>();
    for (const post of posts) {
        const cats = post.data.categories ?? [];
        for (const c of cats) {
            counts.set(c, (counts.get(c) ?? 0) + 1);
        }
    }
    return Array.from(counts.entries()).map(([category, count]) => ({
        params: { category },
        props: { category, count },
    }));
}

const { category, count } = Astro.props;
const allPosts = await getCollection("posts", ({ data }) => !data.draft);
const filteredPosts = allPosts.filter((post) => {
    const cats = post.data.categories ?? [];
    return cats.includes(category);
});
const latestPost = filteredPosts.reduce((latest, post) => {
    const postTime = post.data.updated ?? post.data.date;
    const latestTime = latest.data.updated ?? latest.data.date;
    return postTime > latestTime ? post : latest;
}, filteredPosts[0]);
const lastUpdateDate = latestPost
    ? dayjs(latestPost.data.updated ?? latestPost.data.date).format(
          "YYYY年MM月DD日",
      )
    : "未知";
---

<Stalux
    stalux={{
        title: "分类: " + category + " | " + stalux.title,
        description: `浏览分类 ${category} 下的 ${count} 篇文章，涵盖相关领域的深度思考与见解。最后更新于 ${lastUpdateDate}`,
        url: Astro.url.href,
        twitterSite: stalux.twitterSite,
        noindex: stalux.noindex,
        nofollow: stalux.nofollow,
        anyhead: stalux.anyhead,
    }}
>
    <div style="height: 3em;"></div>
    <Navs />
    <TagHeader type={"分类"} name={category} count={count} />
    <PostList
        filter={(posts: CollectionEntry<"posts">[]) => {
            return posts.filter((post) => {
                const cats = post.data.categories ?? [];
                return cats.includes(category);
            });
        }}
        posts={allPosts}
    />
</Stalux>
