---
import PostList from "@components/stalux/posts/postList.astro";
import TagHeader from "@components/stalux/tags/tagHeader.astro";
import { getCollection, type CollectionEntry } from "astro:content";
import Stalux from "@layouts/Stalux.astro";
import dayjs from "dayjs";
import Navs from "@components/stalux/layout/navs.astro";
const stalux = (await getCollection("config"))[0].data;
export async function getStaticPaths() {
    const posts = await getCollection("posts", ({ data }) => !data.draft);
    const categoryMap = new Map<
        string,
        { posts: CollectionEntry<"posts">[]; latestTime: Date }
    >();

    for (const post of posts) {
        const cats = post.data.categories ?? [];
        const postTime = post.data.updated ?? post.data.date;
        for (const c of cats) {
            if (!categoryMap.has(c)) {
                categoryMap.set(c, { posts: [], latestTime: postTime });
            }
            const entry = categoryMap.get(c)!;
            entry.posts.push(post);
            if (postTime > entry.latestTime) {
                entry.latestTime = postTime;
            }
        }
    }

    return Array.from(categoryMap.entries()).map(([category, entry]) => ({
        params: { category },
        props: {
            category,
            count: entry.posts.length,
            posts: entry.posts,
            lastUpdateDate: dayjs(entry.latestTime).format("YYYY年MM月DD日"),
        },
    }));
}

const { category, count, posts, lastUpdateDate } = Astro.props;
---

<Stalux
    stalux={{
        title: "分类: " + category + " | " + stalux.title,
        description: `浏览分类 ${category} 下的 ${count} 篇文章，涵盖相关领域的深度思考与见解。最后更新于 ${lastUpdateDate}`,
        url: Astro.url.href,
        twitterSite: stalux.twitterSite,
        noindex: stalux.noindex,
        nofollow: stalux.nofollow,
        anyhead: stalux.anyhead,
    }}
>
    <div style="height: 3em;"></div>
    <Navs />
    <TagHeader type={"分类"} name={category} count={count} />
    <PostList posts={posts} />
</Stalux>
